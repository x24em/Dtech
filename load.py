#!/usr/bin/env python3
"""
D-TECH YouTube/TikTok Downloader CLI for Termux
Continuous CLI: enter URLs to download without restarting.
Automatically installs needed packages on first run, saves media in external storage path, and triggers media scan.
"""
import os
import sys
import uuid
import base64
import shutil
import subprocess
from datetime import datetime

# Marker files
PERM_MARKER = os.path.expanduser("~/.termux_storage_permission_granted")
SETUP_MARKER = os.path.expanduser("~/.dtech_setup_complete")

# Embedded cookies and file
COOKIES_FILE = "cookies.txt"
EMBEDDED_COOKIES = """IyBOZXRzY2FwZSBIVFRQIENvb2tpZSBGaWxlCiMgaHR0cHM6Ly9jdXJsLmhheHguc2UvcmZjL2Nvb2tpZV9zcGVjLmh0bWwKIyBUaGlzIGlzIGEgZ2VuZXJhdGVkIGZpbGUhIERvIG5vdCBlZGl0LgoKLmdvb2dsZS5jb20JVFJVRQkvdmVyaWZ5CVRSVUUJMTc2NTIwMjgzNAlTTklECUFCYWJsbmM3djgtTHhLUUxOR0Rla21RQUg2NlpQSU1WaHVzdjA3Z1A3LVFtVUhfdDBWWDRCRzV1NEVWZ0xGWUMyQmJNeE1wd2VvaWhROXotX0NYOWVFTmtyRGpMNnBWbDV1VQp3d3cud2lraXBlZGlhLm9yZwlGQUxTRQkvCVRSVUUJMTc1MjE4ODY4NglXTUYtTGFzdC1BY2Nlc3MJMDgtSnVuLTIwMjUKLndpa2lwZWRpYS5vcmcJVFJVRQkvCVRSVUUJMTc1MjE4ODY4NglXTUYtTGFzdC1BY2Nlc3MtR2xvYmFsCTA4LUp1bi0yMDI1Ci53aWtpcGVkaWEub3JnCVRSVUUJLwlUUlVFCTE3ODA5MTY2ODYJV01GLVVuaXEJcktVYVZIMmhSbTRra1gzWGRiU1RqUUlGQUFJQkFGdmROdkFHSk1fMTE4RDFsNUhlRWlLZGhyVVZNY2pSV25SNgoubW96aWxsYS5vcmcJVFJVRQkvCUZBTFNFCTE3ODMzNDYxOTUJX2dhX0I5Q1kxQzlWQkMJR1MyLjEuczE3NDg3ODYwNjgkbzEkZzEkdDE3NDg3ODYxOTUkajYwJGwwJGgwCi5tb3ppbGxhLm9yZwlUUlVFCS8JRkFMU0UJMTc4MzM0NjE5NQlfZ2EJR0ExLjEuMTQ2OTYxNTc4NC4xNzQ4Nzg2MDY5Ci5tb3ppbGxhLm9yZwlUUlVFCS8JRkFMU0UJMTc0ODg3MjU5MwlfZ2lkCUdBMS4yLjkxNDE1NjM5Ni4xNzQ4Nzg2MDY5Ci5tb3ppbGxhLm9yZwlUUlVFCS8JRkFMU0UJMTc0ODc4NjI1MwlfZ2F0CTEKLmdvb2dsZS5jb20JVFJVRQkvCVRSVUUJMTc2NDMzODE5NglBRUMJQVZoX1YyZ3M3ODhHYmJYdW5lcVQ3cExXcnFlVFpvQlRnMTJJalBYdXRZM25GVUluUnVacnAzcUZGQQouZ29vZ2xlLmNvbQlUUlVFCS8JVFJVRQkxNzY1MjAyODM0CU5JRAk1MjQ9al9DM2dNMkFPWEs0c1BaVDk1bzFtOGhwZVR3UndpV3pKeFB1UEF6dDZvb25XS2RyRW5hNk5hNGVoV3Awd0VmSWlIc1N2YkgwaXE4Q1p0QXZjNzM4U2xwdUNkZXctVlVzUmtyTXRENDRPVUlUcmhIYmhJSjhCbmRZaWdlT3BZeFpSd19XRmM1U2FFdEIzbEtkUV9rUFA5S28wSHBQd2wwOXZ0dTNOMXRjMDc5WmZ0clhoMEtoU05wdUlqaGNMS1pLYjN3UXBWWWFwTUhBM1ZITjQyd3pBa1FpZ2F1YmY2WFNSSFF3TERzZUxBQ0tEYS03RlBuaFlsS0d0dHV1Z3ZkdkZxXzdiUWdseWZFaE51SF9MdnJKTmZKSC1JanRvYzBSN2tCenlSdGFwVlF5MjhuNi1jbkRCX2Rjbk9wV2dJbVRlSGNaMnlhM1doLVFlYndBUGZqb0dSWTJiTnhaSE9VeVE0M1ltQy1ZTTRCMW9lMm5KS0hUWExkUXJFSE5ZVTA2VlZnOEFDcnE1T3c4NUFRSWdiZEluNXRyVGtPOWxuOXFnbXRnRjhXSXEzSUk0RjBpUjZMTWI3Y2dNTXJkNkU0Z0VKeUZSbUFpV1RuUGdtWWQ0ejdjUGhYeWlMamtvY0FHTTl2SUtFZFpEWF8tSU1kbmYzNTFLYXR3Q1NXdHNOQ3pxdjRST2pSMWVtaGNmbEl0VkU3Q1VxRk1VTm5IMF8ycGlTNjZfV09BNlFaTDNqQTR4X0VQY2phSHkzS3ZOLXdQLWVsdW53RXlBSnlkalZXQjFRUG0tb19jeHNxZWpMYWdhalhNbVFFUE0yX1BuSnR2ZWNuNU1rcDQtZjFWM04tVmI4VVNCamtISmtxTVI3RmZFS1JkWGhsaVBEeHcxXzIyeXVUS3ZYYUdYQ3hNWmd6UHd1MmwxUFBqU3F3WmhMYWlhR1NlOXQzeTV1cmxzLWgzRFJFCi50aWt0b2suY29tCVRSVUUJLwlUUlVFCTE3ODA5Mjc3MzQJdHR3aWQJMSU3Q1A5bHZIZVZEMkpnMjZHUEFTcm9XSmVEalBBM0xiWVI0cFk3Q3pOekQ4OHclN0MxNzQ5MzkxNzM0JTdDYTgzZmY3YjIxNGQyMjNlMWQ5MGZmYzY3ODUwZjk1MzIxZjk0NDM2MDVhNjM5YjYyNzQ4NDI0MjVkYmViYjI0Ygoud3d3LnRpa3Rvay5jb20JVFJVRQkvCVRSVUUJMTc3NTMxMTgxNgl0aWt0b2tfd2ViYXBwX3RoZW1lX3NvdXJjZQlsaWdodAoud3d3LnRpa3Rvay5jb20JVFJVRQkvCVRSVUUJMTc3NTMxMTgxNgl0aWt0b2tfd2ViYXBwX3RoZW1lCWxpZ2h0Ci50aWt0b2suY29tCVRSVUUJLwlUUlVFCTE3NTM5NzAyMDgJcGFzc3BvcnRfY3NyZl90b2tlbglhMTA3Nzk4NTNhMjc2ZjEyOTczMmNjYjkzYTYxZDE0MwoudGlrdG9rLmNvbQlUUlVFCS8JVFJVRQkxNzUzOTcwMjA4CXBhc3Nwb3J0X2NzcmZfdG9rZW5fZGVmYXVsdAlhMTA3Nzk4NTNhMjc2ZjEyOTczMmNjYjkzYTYxZDE0MwoudGlrdG9rLmNvbQlUUlVFCS8JVFJVRQkxNzQ4Nzg2NTA4CXBhc3Nwb3J0LXNvdGwtYXV0aC10b2tlbi1ub25jZV9KcWxmQUZDM3RhNmZYbDBSS0l6TUJIQkwxNDFXc0prSGNOQkVja012TDNBCUpxbGZBRkMzdGE2ZlhsMFJLSXpNQkhCTDE0MVdzSmtIY05CRWNrTXZMM0EKLnRpa3Rvay5jb20JVFJVRQkvCVRSVUUJMTc1MDI1NTgzNgltc1Rva2VuCWl6R00zT3pUVDFoZk5HMktNbTNZcEdySXozOU1zdUZYRkJzWUdlaWR2enNxVDJtYUQ3WkI3ZVRHaUxaTVZ4OElkWHBvWG1jYmdMVGczb04wYVNUbTlTakVqTC1hM3VWMFhxUmxYZXZxd19Ic0VCT1hnV3lHUkpuX1BscF9rT1MxS3ZyaFFVMGI3Zm50V1U3X1dHNUoKYWNjb3VudHMuZ29vZ2xlLmNvbQlGQUxTRQkvCVRSVUUJMTc4Mzk1MTY1MAlfX0hvc3QtR0FQUwkxOjNmazZpa0tCSGFtbWNuM2l0V0RLOFo5c0VDUnoyaWtUWlZQb1Mxd0t4dGdNbzRYc3BCMHluaTQzWDRKTHk5OVRkYkNmVWZtQm8tMXNkYlFUYUlmR3RkRk5RaldSY0E6UkRjVWEzYnpGT2pxYXVScQphY2NvdW50cy5nb29nbGUuY29tCUZBTFNFCS8JVFJVRQkxNzUxMzc4MjIzCU9UWgk4MTA4MDM3XzQ4XzQ4X180OF8KLmdvb2dsZS5jb20JVFJVRQkvCUZBTFNFCTE3ODMzNDYyNTYJU0lECWcuYTAwMHhnaXk2MHQ3S01LU1pCWDM0eWt1cUgwbFViSFc3Q0FoM3hmU2JMRnIyNzVLU0NLSEFVUUpaOC14MWdVUzVXM1NZYmg2UVFBQ2dZS0FYZ1NBUlVTRlFIR1gyTWlJWjd1YTZ4M2N0Qmp1T2dvZ2pyY2dCb1ZBVUY4eUtyZTRNME5qTzFCbXdCUTNkdUVVOUYtMDA3NgouZ29vZ2xlLmNvbQlUUlVFCS8JVFJVRQkxNzgzMzQ2MjU2CV9fU2VjdXJlLTFQU0lECWcuYTAwMHhnaXk2MHQ3S01LU1pCWDM0eWt1cUgwbFViSFc3Q0FoM3hmU2JMRnIyNzVLU0NLSEFqYW8wRDhZQWN4OC01YmREcDd4ZXdBQ2dZS0FlNFNBUlVTRlFIR1gyTWlIVGQ0TnZXdE9hdWllQUEyYldNczlSb1ZBVUY4eUtxNjhGUTJOT3dsejVyZ3VoaGRqVVhQMDA3NgouZ29vZ2xlLmNvbQlUUlVFCS8JVFJVRQkxNzgzMzQ2MjU2CV9fU2VjdXJlLTNQU0lECWcuYTAwMHhnaXk2MHQ3S01LU1pCWDM0eWt1cUgwbFViSFc3Q0FoM3hmU2JMRnIyNzVLU0NLSEh6eGJqZld1NmZLOUtFM2o5S3BGWVFBQ2dZS0FmMFNBUlVTRlFIR1gyTWlfdmhvbTIwcFhEdUJfSWZxOENDYjVCb1ZBVUY4eUtwb2wyVDdiZDRveThLNzl4LWM3Q1VPMDA3NgphY2NvdW50cy5nb29nbGUuY29tCUZBTFNFCS8JVFJVRQkxNzgzMzQ2MjU3CUxTSUQJcy5aQXxzLnlvdXR1YmU6Zy5hMDAweGdpeTY2Tl9PQnlobzFKX2JBV0ZDaE9ZWXR3NWhVMDBuU0lJOG5jZVpoNW55djZSc2ZSaTJ5RFlaczZSY08zRlBpOFl6Z0FDZ1lLQWJRU0FSVVNGUUhHWDJNaTd4elZHS0FVMkZ2MkplcUxxeko5d3hvVkFVRjh5S3BoTUdpbndFVzNsaG1EWlRpSXhiQTMwMDc2CmFjY291bnRzLmdvb2dsZS5jb20JRkFMU0UJLwlUUlVFCTE3ODMzNDYyNTcJX19Ib3N0LTFQTFNJRAlzLlpBfHMueW91dHViZTpnLmEwMDB4Z2l5NjZOX09CeWhvMUpfYkFXRkNoT1lZdHc1aFUwMG5TSUk4bmNlWmg1bnl2NlJJUjJ4NlBhNTFVUWxMT0ZkX2xzTE53QUNnWUtBUXdTQVJVU0ZRSEdYMk1pdE1Qc1NBS0otMURBM1RJVV9YV2daQm9WQVVGOHlLb3M0NWJpRmJMMzBmZUFnbDF2NmJsZTAwNzYKYWNjb3VudHMuZ29vZ2xlLmNvbQlGQUxTRQkvCVRSVUUJMTc4MzM0NjI1NwlfX0hvc3QtM1BMU0lECXMuWkF8cy55b3V0dWJlOmcuYTAwMHhnaXk2Nk5fT0J5aG8xSl9iQVdGQ2hPWVl0dzVoVTAwblNJSThuY2VaaDVueXY2UnFwa3N0bllNRWdFaHpNRURsRlBtSXdBQ2dZS0FYa1NBUlVTRlFIR1gyTWlkQllGUVEySU4wckVzYjNzNFFnWUtSb1ZBVUY4eUtwVnBhVXBHR0F3ZldiWnVJLUFMYmJoMDA3NgouZ29vZ2xlLmNvbQlUUlVFCS8JRkFMU0UJMTc4MzM0NjI1NglIU0lECUFjVm5kMEw1YjNJb2h5UHp5Ci5nb29nbGUuY29tCVRSVUUJLwlUUlVFCTE3ODMzNDYyNTYJU1NJRAlBTFA3ZU5NUHNmdGljbk5aZQouZ29vZ2xlLmNvbQlUUlVFCS8JRkFMU0UJMTc4MzM0NjI1NglBUElTSUQJNHZ4bEJSRnV0bjBzVm5LWi9BX2FaTjV2ODREaHI4U3NZNAouZ29vZ2xlLmNvbQlUUlVFCS8JVFJVRQkxNzgzMzQ2MjU2CVNBUElTSUQJRTZMMVBxbWZQdFVRUDhNby9BdVBKRzdVOHB3WE5MeVpvTAouZ29vZ2xlLmNvbQlUUlVFCS8JVFJVRQkxNzgzMzQ2MjU2CV9fU2VjdXJlLTFQQVBJU0lECUU2TDFQcW1mUHRVUVA4TW8vQXVQSkc3VThwd1hOTHlab0wKLmdvb2dsZS5jb20JVFJVRQkvCVRSVUUJMTc4MzM0NjI1NglfX1NlY3VyZS0zUEFQSVNJRAlFNkwxUHFtZlB0VVFQOE1vL0F1UEpHN1U4cHdYTkx5Wm9MCmFjY291bnRzLmdvb2dsZS5jb20JRkFMU0UJLwlUUlVFCTE3ODMzNDYyNTcJQUNDT1VOVF9DSE9PU0VSCUFGeF9xSTY1RTdtc1F0dmlfeDNvVTk4ZXVOSFJxS290eUJkSXdBSGg2dVVVLWxBMHRLTGl4dTVURWR4TEtSTmZNWmYyaFVSTTVRR0hORUl6THhNTTR1ZlhCQlJQTUFhV3NFR05pWVVaS1h2U2lyUmpicUZUc2NkVXlWWm0wWmh2VGQ1NTJMcTdZVUpnCi5nb29nbGUuY29tCVRSVUUJLwlGQUxTRQkxNzgwOTI3NzI3CVNJRENDCUFLRXlYeldOUTVBY0wtRGFfOUdaZnVxdDh0MWdPcWFNNWtrVElPakw3ZFpBTWsxdklGTmdZT1hjM3RzTHJ1LXE3TWVnQUFGZjZnCi5nb29nbGUuY29tCVRSVUUJLwlUUlVFCTE3ODA5Mjc3MjcJX19TZWN1cmUtMVBTSURDQwlBS0V5WHpXdkp6QVdPeHAyZTkzYUxsRmJ6Zjh5ZUR6NVJiOUNGeHRUejljb0xMeWFKeUFpNVN0WFl6SG5QQnV2d3BtZHZQRGIKLmdvb2dsZS5jb20JVFJVRQkvCVRSVUUJMTc4MDkyNzcyNwlfX1NlY3VyZS0zUFNJRENDCUFLRXlYelY2MkFmTUpyTkxtNUJKS1NKamxhY3dUTFpaS2tYRk9ZM2FtbldRU2dMbmlMR1Rxa3NfdUtrTTVGY05DaTdpd0dWM0h3CmFjY291bnRzLmdvb2dsZS5jb20JRkFMU0UJLwlUUlVFCTE3ODAzMjIyNjcJTFNPTEgJX1NWSV9FSl9Hck1LdzBJMERHQU1pUDAxQlJVUklabDl4U21kWlIxZDVhRVkxWDFOdFZXMTNZMWxQVldsYWJFdElhRkZsV1hoTFNIaHhiRzA0YzJaVFNGZHhhamR2VkhCQlVrNUpYMGRyU1FfOjI5MTQ2NDUyOjU1ZDUKLnRpa3Rvay5jb20JVFJVRQkvCVRSVUUJMTc1Mzk3MDI4MAltdWx0aV9zaWRzCTc0MDc5MDk2OTIxMTY5Mjc0OTMlM0E4NmFiMzFlYmM2ZDM5NWUzNjZhNDNmYjY5ZjA5OTBiOQoudGlrdG9rLmNvbQlUUlVFCS8JVFJVRQkxNzUzOTcwMjgwCWNtcGxfdG9rZW4JQWdRUUFQTVlGLVJPMHJid3dEbzJfMTA4OGwzRklTT1dmNFNUWU44bHNnCi50aWt0b2suY29tCVRSVUUJLwlGQUxTRQkxNzUxMzc4MjgwCXBhc3Nwb3J0X2F1dGhfc3RhdHVzCWM2ZDQxNDg1ZTBmMTkyNzQxN2I5MGE1YjJiZTkwOWY1JTJDCi50aWt0b2suY29tCVRSVUUJLwlUUlVFCTE3NTEzNzgyODAJcGFzc3BvcnRfYXV0aF9zdGF0dXNfc3MJYzZkNDE0ODVlMGYxOTI3NDE3YjkwYTViMmJlOTA5ZjUlMkMKLnRpa3Rvay5jb20JVFJVRQkvCVRSVUUJMTc3OTg5MDI4MwlzaWRfZ3VhcmQJODZhYjMxZWJjNmQzOTVlMzY2YTQzZmI2OWYwOTkwYjklN0MxNzQ4Nzg2Mjg0JTdDMTU1NTE5OTclN0NGcmklMkMrMjgtTm92LTIwMjUrMTMlM0E1OCUzQTAxK0dNVAoudGlrdG9rLmNvbQlUUlVFCS8JVFJVRQkxNzY0MzM4MjgwCXVpZF90dAlkMmI2YWI0NWYwMDBlNmIwMWEwZjMxNTUwYWY2ZDk1OTIyZDhjOWUxZGNiMTVkMWQ4ZTA4NzNjZGFlZjFiOTIzCi50aWt0b2suY29tCVRSVUUJLwlUUlVFCTE3NjQzMzgyODAJdWlkX3R0X3NzCWQyYjZhYjQ1ZjAwMGU2YjAxYTBmMzE1NTBhZjZkOTU5MjJkOGM5ZTFkY2IxNWQxZDhlMDg3M2NkYWVmMWI5MjMKLnRpa3Rvay5jb20JVFJVRQkvCVRSVUUJMTc2NDMzODI4MAlzaWRfdHQJODZhYjMxZWJjNmQzOTVlMzY2YTQzZmI2OWYwOTkwYjkKLnRpa3Rvay5jb20JVFJVRQkvCVRSVUUJMTc2NDMzODI4MAlzZXNzaW9uaWQJODZhYjMxZWJjNmQzOTVlMzY2YTQzZmI2OWYwOTkwYjkKLnRpa3Rvay5jb20JVFJVRQkvCVRSVUUJMTc2NDMzODI4MAlzZXNzaW9uaWRfc3MJODZhYjMxZWJjNmQzOTVlMzY2YTQzZmI2OWYwOTkwYjkKLnRpa3Rvay5jb20JVFJVRQkvCVRSVUUJMTc2NDMzODI3OQlzaWRfdWNwX3YxCTEuMC4wLUtESXlObU5sWWpKak56Y3pPV00zTnprMllqTTBORE5qWTJZMU9UWmpaV0l4TkdVME5tTTBaamdLR1FpRmlMYjIyOU9MNTJZUTZyanh3UVlZc3dzNENFQVNTQVFRQXhvR2JXRnNhWFpoSWlBNE5tRmlNekZsWW1NMlpETTVOV1V6TmpaaE5ETm1Zalk1WmpBNU9UQmlPUQoudGlrdG9rLmNvbQlUUlVFCS8JVFJVRQkxNzY0MzM4Mjc5CXNzaWRfdWNwX3YxCTEuMC4wLUtESXlObU5sWWpKak56Y3pPV00zTnprMllqTTBORE5qWTJZMU9UWmpaV0l4TkdVME5tTTBaamdLR1FpRmlMYjIyOU9MNTJZUTZyanh3UVlZc3dzNENFQVNTQVFRQXhvR2JXRnNhWFpoSWlBNE5tRmlNekZsWW1NMlpETTVOV1V6TmpaaE5ETm1Zalk1WmpBNU9UQmlPUQp3d3ctdXNlYXN0MWEudGlrdG9rLmNvbQlGQUxTRQkvCUZBTFNFCTE3NDkzOTEwODAJdHRfdGlja2V0X2d1YXJkX2hhc19zZXRfcHVibGljX2tleQkxCi50aWt0b2suY29tCVRSVUUJLwlGQUxTRQkxNzY0MzM4MjgwCXN0b3JlLWlkYwltYWxpdmEKLnRpa3Rvay5jb20JVFJVRQkvCUZBTFNFCTE3NjQzMzgyODAJc3RvcmUtY291bnRyeS1zaWduCU1FSUVETEdoek0ybU9aUEl6YTZCeVFRZ19JMjdKUWs3UFhsbTdGWjdYYTBibWRPMXJxRE1saXZKM18waWQ3WmVNNGdFRVBQQkFVLXhHZ3dzSk9VNlVtT2gwWDQKLnRpa3Rvay5jb20JVFJVRQkvCUZBTFNFCTE3NjQzMzgyODAJc3RvcmUtY291bnRyeS1jb2RlCXphCi50aWt0b2suY29tCVRSVUUJLwlGQUxTRQkxNzY0MzM4MjgwCXN0b3JlLWNvdW50cnktY29kZS1zcmMJdWlkCi50aWt0b2suY29tCVRSVUUJLwlGQUxTRQkxNzY0MzM4MjgwCXR0LXRhcmdldC1pZGMJdXNlYXN0MWEKLnRpa3Rvay5jb20JVFJVRQkvCUZBTFNFCTE3ODAzMjIyODMJdHQtdGFyZ2V0LWlkYy1zaWduCWhBcXZjMk9qQmtkaFN4OGtWeUVpc0dLRkJMM0VheUJmdDVtMWxCTGhhdzdjZWtXV0hNLWRPOGZ3b2tkUENBY2lkUDNHMHJtZUJBLUEtVTdNTUJmdk9DdDB3M1RDZG11ajZvRUxEb0lYeFVNYkxoS0x5Ul9mNm54dGtVaC1JeVhJWERmOENfRlZRTm4zWlU4RGVPd080aHEyRmZ3eGRPanpYb054VndDWUdzZmpuVVR5QUtxU3ZZVlQwNXJOX3U3cDhDSHpzZXlVaUlxVnNCWTlzRkxpNm9HUXNuTzQweVRlQXlfTmV6S3hwQTNkdTZRanpXQldMMzQxNW1JSzlUTDhzWjdVMHpzX2hxdnVud0RvblpSaUY5bHZWTUpRY21keUJ5dktmRUZTamFsTFNvQWRqOUZFQjlnd3E0TnlxRjV2NFM0dWwxV3hROC16aElzRlZhMDJUNnNWeVlKU3NjRmRObjRtSkItb1lmamxZMno4X2lCYmxuMGRtR1EtaUR1bGxtMzZBdHZPdTk1Zmw1c1BEMEJTZGlfdjZRVUl5OWx5VGNiLWdRUGpSSlJvOENMZHhoWk9aVnd5cC1IVUl3YnNFVUNIOGFsRlh0X1lpdGg3SGJQY2pPWUdGR3N1LVM3NV9GQjZYb2hqaXFtcUJiVUZTVXF6YXJjbnVSMmJUc0N1Cnd3dy50aWt0b2suY29tCUZBTFNFCS8JRkFMU0UJMTc1NjU2MjI4MAlsYXN0X2xvZ2luX21ldGhvZAlnb29nbGUKLnRpa3Rvay5jb20JVFJVRQkvCVRSVUUJMTc2NDk0MzgxMAl0dF9jaGFpbl90b2tlbglqeEpYeGhwNmlxSVlmT2pwM0tXSjVnPT0KLnRpa3Rvay5jb20JVFJVRQkvCUZBTFNFCTE3ODAzMjIyOTMJb2Rpbl90dAlhNzMxMjI2YjAyNGI4YzU1NjdiMDE2MzlhYzllZWIyZjg4OGNiNjljNmFjY2RiN2E2ODI4NjJhNzBhZDcwMWE5MWJjODc5NTE0ZTczNWRmZDEzZTMzNGU0NjIxNjc4YmM3OWFiOWFiYzhkNjdlMTFjYTBiZDcyYmUxODgyMjk0OGU4ZGZjZTA2NDM1NTczZTcwZTBkOWI2N2VjY2ExNmE1Ci5nb29nbGUuY29tCVRSVUUJLwlGQUxTRQkxNzY0OTQzNjMzCVNFQVJDSF9TQU1FU0lURQlDZ1FJbDU0QgoueW91dHViZS5jb20JVFJVRQkvCVRSVUUJMTc0OTM5MzQzOQlHUFMJMQoueW91dHViZS5jb20JVFJVRQkvCVRSVUUJMTc2NDk0Mzg0NwlWSVNJVE9SX0lORk8xX0xJVkUJX1dTTlNDSW1jZlUKLnlvdXR1YmUuY29tCVRSVUUJLwlUUlVFCTE3NjQ5NDM4NDcJVklTSVRPUl9QUklWQUNZX01FVEFEQVRBCUNnSmFRUklFR2dBZ0pnJTNEJTNECi55b3V0dWJlLmNvbQlUUlVFCS8JVFJVRQkxNzY0OTQzNjUyCV9fU2VjdXJlLVJPTExPVVRfVE9LRU4JQ1BhZW9zSDU5YS13eWdFUXY0dXcydl9oalFNWTFLalk0UF9oalFNJTNECi55b3V0dWJlLmNvbQlUUlVFCS8JVFJVRQkxNzgzOTUxODQ5CVBSRUYJZjY9NDAwMDAwMDAmdHo9QWZyaWNhLkpvaGFubmVzYnVyZwoueW91dHViZS5jb20JVFJVRQkvCVRSVUUJMTc4MDkyNzY1MQlfX1NlY3VyZS0xUFNJRFRTCXNpZHRzLUNqSUI1SDAzUDN1RWJIeVdwU1ZfSkNXbVgtcmZzVDMwT0dIaVlOb2pVdXJRdmZSVEhmanRSbFZBOGJ4c2xza2RoSFkwaGhBQQoueW91dHViZS5jb20JVFJVRQkvCVRSVUUJMTc4MDkyNzY1MQlfX1NlY3VyZS0zUFNJRFRTCXNpZHRzLUNqSUI1SDAzUDN1RWJIeVdwU1ZfSkNXbVgtcmZzVDMwT0dIaVlOb2pVdXJRdmZSVEhmanRSbFZBOGJ4c2xza2RoSFkwaGhBQQoueW91dHViZS5jb20JVFJVRQkvCUZBTFNFCTE3ODM5NTE2NTEJSFNJRAlBUlZ2OC1QMTJPMEJhdm9aNgoueW91dHViZS5jb20JVFJVRQkvCVRSVUUJMTc4Mzk1MTY1MQlTU0lECUFSZDZsTnhIdkZ5RU9Wc25OCi55b3V0dWJlLmNvbQlUUlVFCS8JRkFMU0UJMTc4Mzk1MTY1MQlBUElTSUQJNHZ4bEJSRnV0bjBzVm5LWi9BX2FaTjV2ODREaHI4U3NZNAoueW91dHViZS5jb20JVFJVRQkvCVRSVUUJMTc4Mzk1MTY1MQlTQVBJU0lECUU2TDFQcW1mUHRVUVA4TW8vQXVQSkc3VThwd1hOTHlab0wKLnlvdXR1YmUuY29tCVRSVUUJLwlUUlVFCTE3ODM5NTE2NTEJX19TZWN1cmUtMVBBUElTSUQJRTZMMVBxbWZQdFVRUDhNby9BdVBKRzdVOHB3WE5MeVpvTAoueW91dHViZS5jb20JVFJVRQkvCVRSVUUJMTc4Mzk1MTY1MQlfX1NlY3VyZS0zUEFQSVNJRAlFNkwxUHFtZlB0VVFQOE1vL0F1UEpHN1U4cHdYTkx5Wm9MCi55b3V0dWJlLmNvbQlUUlVFCS8JRkFMU0UJMTc4Mzk1MTY1MQlTSUQJZy5hMDAweGdpeTYwdDdLTUtTWkJYMzR5a3VxSDBsVWJIVzdDQWgzeGZTYkxGcjI3NUtTQ0tIQVVRSlo4LXgxZ1VTNVczU1liaDZRUUFDZ1lLQVhnU0FSVVNGUUhHWDJNaUlaN3VhNngzY3RCanVPZ29nanJjZ0JvVkFVRjh5S3JlNE0wTmpPMUJtd0JRM2R1RVU5Ri0wMDc2Ci55b3V0dWJlLmNvbQlUUlVFCS8JVFJVRQkxNzgzOTUxNjUxCV9fU2VjdXJlLTFQU0lECWcuYTAwMHhnaXk2MHQ3S01LU1pCWDM0eWt1cUgwbFViSFc3Q0FoM3hmU2JMRnIyNzVLU0NLSEFqYW8wRDhZQWN4OC01YmREcDd4ZXdBQ2dZS0FlNFNBUlVTRlFIR1gyTWlIVGQ0TnZXdE9hdWllQUEyYldNczlSb1ZBVUY4eUtxNjhGUTJOT3dsejVyZ3VoaGRqVVhQMDA3NgoueW91dHViZS5jb20JVFJVRQkvCVRSVUUJMTc4Mzk1MTY1MQlfX1NlY3VyZS0zUFNJRAlnLmEwMDB4Z2l5NjB0N0tNS1NaQlgzNHlrdXFIMGxVYkhXN0NBaDN4ZlNiTEZyMjc1S1NDS0hIenhiamZXdTZmSzlLRTNqOUtwRllRQUNnWUtBZjBTQVJVU0ZRSEdYMk1pX3Zob20yMHBYRHVCX0lmcThDQ2I1Qm9WQVVGOHlLcG9sMlQ3YmQ0b3k4Szc5eC1jN0NVTzAwNzYKLnlvdXR1YmUuY29tCVRSVUUJLwlGQUxTRQkxNzgwOTI3ODUzCVNJRENDCUFLRXlYeldKNGhtNnBNdnJ4ajNsWnhBUmIwNVk1Z0NaQnNaaGRzbEtNTDdqWmhvN0J4X2loWDYwZlpvR1l4YVRXbGN6ZVJ6agoueW91dHViZS5jb20JVFJVRQkvCVRSVUUJMTc4MDkyNzg1MwlfX1NlY3VyZS0xUFNJRENDCUFLRXlYelVNemFzQXBTT3FwWHNuOWJjQ05yX3lvdDh0TXA4VmJrTGNISnQ1aTRLUk9fOHFOek51ekczakVValBuVHR0ZmlyWQoueW91dHViZS5jb20JVFJVRQkvCVRSVUUJMTc4MDkyNzg1MwlfX1NlY3VyZS0zUFNJRENDCUFLRXlYeldnYi1pejR0UUMzYWRPbTViLXVhbGNVbVIxcWtGeWMxNFZiMG9Ka1FvWTMyLTZKcHUtb2xRV1Y0bmRlSk5vRXp5YzJnCi55b3V0dWJlLmNvbQlUUlVFCS8JVFJVRQkxNzgzOTUxNjUyCUxPR0lOX0lORk8JQUZtbUYyc3dSUUloQUsxcEQwY09DTFhrQWlIMGtBeDR0REkyWVhFSVE2YUxNaU5SNmR2aEw4a05BaUF1NV9NYTNwdXFJckE3UHFldFFWckhzZFVLaGpUOS1RTkxIdHJlMGdsZUlROlFVUTNNak5tZDNCTU5IaHdZalEyVUdsSFNXTlRXbFpGVkV0RVJHY3ljM0ZrYkRGWVdUWjVVV05IUVRONFZtNWxTbmxoYTBKaFF6bHBUV1Z5UVd0U0xVSjBSR3BVZVhOemNUTm5TMkpUYTBzelkwWkxUMTkzTTNSS2R6QkdjMVY0YXpCdWIwWTVNME5rVkMxUVRXOVpiMFJZZFZJMk9FOUhWVE5NTldSaWNYYzJRbkJ3YVVGU1YyMXRaMEZoV21WdGQyODBPV3hXVm5WdVVqVTJOV2RXVGs1MwoueW91dHViZS5jb20JVFJVRQkvCUZBTFNFCTE3NDkzOTE2ODcJU1QtMTQzcno3bAljc249UWg1cmd6OU51Vk1OanF4YSZpdGN0PUNCZ1EwOHdCR0FFaUV3amQwTjNnXy1HTkF4WHRDZ01GSGRoN0owMHlCbWN0YUdsbmFBJTNEJTNECi55b3V0dWJlLmNvbQlUUlVFCS8JRkFMU0UJMTc0OTM5MTY4OAlTVC0xeXVwcjJnCWNzbj1RaDVyZ3o5TnVWTU5qcXhhJml0Y3Q9Q0JFUW1iY0JHQUlpRXdqZDBOM2dfLUdOQXhYdENnTUZIZGg3SjAwJTNECi55b3V0dWJlLmNvbQlUUlVFCS8JRkFMU0UJMTc0OTM5MTY4OQlTVC0xeDV6YjMJY3NuPVFoNXJnejlOdVZNTmpxeGEmaXRjdD1DQk1ROTZnSEdBQWlFd2pkME4zZ18tR05BeFh0Q2dNRkhkaDdKMDAlM0QKLnlvdXR1YmUuY29tCVRSVUUJLwlGQUxTRQkxNzQ5MzkxNzA1CVNULWhwdnZycwljc249bVZTTk9kWkZmck9hRDlvcSZpdGN0PUNHRVFoX1lFR0FFaUV3aURzc1B2Xy1HTkF4Vy13VUlGSGVadU9kWmFEMFpGZDJoaGRGOTBiMTkzWVhSamFKb0JCUWdrRUk0ZQoueW91dHViZS5jb20JVFJVRQkvCUZBTFNFCTE3NDkzOTE3MDMJU1QtdWtzajZ0CWNzbj1tVlNOT2RaRmZyT2FEOW9xJml0Y3Q9Q0M4UV9Gb2lFd2lEc3NQdl8tR05BeFctd1VJRkhlWnVPZFl5Q21jdGFHbG5hQzF5WldOYUQwWkZkMmhoZEY5MGIxOTNZWFJqYUpvQkJoQ09IaGllQVElM0QlM0QKLnlvdXR1YmUuY29tCVRSVUUJLwlGQUxTRQkxNzQ5MzkxNzA3CVNULW8xd3c0aQljc249bVZTTk9kWkZmck9hRDlvcSZpdGN0PUNGa1FoX1lFR0FNaUV3aURzc1B2Xy1HTkF4Vy13VUlGSGVadU9kWmFEMFpGZDJoaGRGOTBiMTkzWVhSamFKb0JCUWdrRUk0ZQoueW91dHViZS5jb20JVFJVRQkvCUZBTFNFCTE3NDkzOTE3MTIJU1QtcnAzOHZ0CWNzbj1tVlNOT2RaRmZyT2FEOW9xJml0Y3Q9Q0dVUWhfWUVHQUFpRXdpRHNzUHZfLUdOQXhXLXdVSUZIZVp1T2RaYUQwWkZkMmhoZEY5MGIxOTNZWFJqYUpvQkJRZ2tFSTRlCi55b3V0dWJlLmNvbQlUUlVFCS8JVFJVRQkxNzQ5MzkyMzA3CUNPTlNJU1RFTkNZCUFLcmV1OXRmV0lYLTVvWm1ld1BHeHlsRHJEakpFX3hGWDdMSEdsU3g2ZHBwSHhrWUlNU1BnVm5oTGxWNjBkcFFncDJqelpfYWZBaVZQTDRxdlhhRGhXbm5rc2ZXMGhlNXJ5cDEwQ3FsLU9WRUdHZE1nNFZEZnJ0OEQtcwoud2lraXBlZGlhLm9yZwlUUlVFCS8JVFJVRQkwCUdlb0lQCVpBOkVDOlBvcnRfRWxpemFiZXRoOi0zMy45NToyNS42Mjp2NAp3d3cud2lraXBlZGlhLm9yZwlGQUxTRQkvCVRSVUUJMTc0OTM5NTQwOAlOZXR3b3JrUHJvYmVMaW1pdAkwLjAwMQoudGlrdG9rLmNvbQlUUlVFCS8JVFJVRQkwCXR0X2NzcmZfdG9rZW4JNjBFbUx6OG4tdnAzVDhnSmc1ZFRMbFA0bEpzOWFiRjQ2NlZvCnd3dy50aWt0b2suY29tCUZBTFNFCS8JRkFMU0UJMTc1NzE2NzgzNAltc1Rva2VuCW03M0pCUkVER0puOF9iZ3hxd0N2MnRnaGRGYjZBMG9FR0pyVmYxakJwY3BfT255MVZKdTVlRjRscEhXNkpxSnFJX0FkbFdWTzVXdU9LdlZ4MmphZ0VzYUZpNXgzRDVaSnI3SjRLaXZjcGpJeDYxWW53aE1NU1B6THZhR0RZeUdmaXUzLTRqYXE2aU13a2tCVHpjTHoKLnd3dy50aWt0b2suY29tCVRSVUUJLwlUUlVFCTE3NDk4MjM4MzgJcGVyZl9mZWVkX2NhY2hlCXslMjJleHBpcmVUaW1lc3RhbXAlMjI6MTc0OTU2NDAwMDAwMCUyQyUyMml0ZW1JZHMlMjI6WyUyMjc1MDEzMTc0MTgxMTU5NjAxMTklMjIlMkMlMjI3NDg4NDUyODMwMTk4NTgyNTM1JTIyXX0KLnlvdXR1YmUuY29tCVRSVUUJLwlUUlVFCTAJWVNDCVRfVDZwajZ5SlJnCg==
"""

# yt-dlp format selector: best video+audio
YT_DLP_FORMAT = 'bestvideo+bestaudio/best'

# Determine download directory: use direct external paths for visibility
def get_download_dir():
    candidates = [
        '/storage/emulated/0/Movies',
        '/sdcard/Movies',
        '/storage/emulated/0/Download',
        '/sdcard/Download'
    ]
    for path in candidates:
        try:
            if os.path.isdir(path) and os.access(path, os.W_OK):
                return path
        except Exception:
            continue
    # fallback to Termux shared if external paths fail
    shared_termux = os.path.expanduser("~/storage/shared/Movies")
    if os.path.isdir(shared_termux):
        return shared_termux
    return os.getcwd()
DOWNLOAD_DIR = get_download_dir()

# --------------- Setup functions ---------------

def ensure_installed(cmd_name, pkg_name):
    """Install a Termux package if the command is missing"""
    if shutil.which(cmd_name) is None:
        print(f"📦 Installing {pkg_name}...")
        subprocess.run(["pkg", "install", "-y", pkg_name], check=False)


def setup_requirements():
    """Install dependencies once per device."""
    print("🔧 Checking and installing dependencies...")
    ensure_installed('yt-dlp', 'yt-dlp')
    ensure_installed('ffmpeg', 'ffmpeg')
    open(SETUP_MARKER, 'w').close()


def ensure_setup():
    if not os.path.exists(SETUP_MARKER):
        setup_requirements()

# --------------- Permission and cookies ---------------

def ensure_storage_permission():
    """Request storage access once via termux-setup-storage."""
    if not os.path.isfile(PERM_MARKER):
        print("🔒 Requesting storage permission...")
        subprocess.run(["termux-setup-storage"], check=False)
        open(PERM_MARKER, 'w').close()


def save_embedded_cookies():
    """Write cookies.txt from embedded base64 if missing."""
    if not os.path.exists(COOKIES_FILE) and EMBEDDED_COOKIES.strip():
        with open(COOKIES_FILE, 'wb') as f:
            f.write(base64.b64decode(EMBEDDED_COOKIES.strip()))
        print("✅ cookies.txt generated from embedded data.")

# --------------- Media download and scan ---------------

def trigger_media_scan(path):
    """Trigger Android media scan so file shows in gallery."""
    try:
        subprocess.run(["termux-media-scan", path], check=False)
    except FileNotFoundError:
        subprocess.run([
            "am", "broadcast",
            "-a", "android.intent.action.MEDIA_SCANNER_SCAN_FILE",
            "-d", f"file://{path}"
        ], check=False)


def download_media(url: str, audio_only: bool = False):
    """Download video or audio and save with current timestamp."""
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    ext = 'mp3' if audio_only else 'mp4'
    filename = f"{timestamp}_{uuid.uuid4()}.{ext}"
    output_path = os.path.join(DOWNLOAD_DIR, filename)

    cmd = [
        'yt-dlp',
        '-f', YT_DLP_FORMAT,
        '--no-mtime',
        '-o', output_path,
        '--cookies', COOKIES_FILE,
        url
    ]
    if audio_only:
        cmd.extend(['--extract-audio', '--audio-format', 'mp3'])

    print(f"⏳ Downloading {'audio' if audio_only else 'video'} to {output_path}...")
    try:
        subprocess.run(cmd, check=True)
        if os.path.isfile(output_path):
            print(f"✅ Download complete: {output_path}")
            trigger_media_scan(output_path)
            print("🔍 Media scanned and should appear in your gallery.\n")
            return True
    except subprocess.CalledProcessError as e:
        print(f"❌ Download failed: {e}\n")
    return False

# --------------- Main loop ---------------

def main_loop():
    print(f"🌟 D-TECH Downloader CLI (continuous mode) 🌟")
    print(f"Media will be saved to: {DOWNLOAD_DIR}\n")
    print("Type 'mp3 <URL>' for audio or just paste <URL> for video. Type 'q' to quit.\n")
    while True:
        user_input = input("> ").strip()
        if not user_input:
            continue
        if user_input.lower() in ('q', 'quit', 'exit'):
            print("👋 Exiting.")
            break
        parts = user_input.split(None, 1)
        if parts[0].lower() == 'mp3' and len(parts) == 2:
            download_media(parts[1], audio_only=True)
        else:
            download_media(parts[0], audio_only=False)


if __name__ == '__main__':
    ensure_setup()
    ensure_storage_permission()
    save_embedded_cookies()
    os.makedirs(DOWNLOAD_DIR, exist_ok=True)
    main_loop()
